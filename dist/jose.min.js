!function(a,b,c,d,e){"use strict";b.subtle||(b.subtle=b.webkitSubtle);var f={},g={},h={};a.setCrypto=function(a){b=a},"function"!=typeof atob&&(atob=function(a){return new Buffer(a,"base64").toString("binary")}),"function"!=typeof btoa&&(btoa=function(a){var b;return b=a instanceof Buffer?a:new Buffer(a.toString(),"binary"),b.toString("base64")}),f.caniuse=function(){var a=!0;return a=a&&"function"==typeof c,a=a&&"function"==typeof c.reject,a=a&&"function"==typeof c.prototype.then,a=a&&"function"==typeof c.all,a=a&&"object"==typeof b,a=a&&"object"==typeof b.subtle,a=a&&"function"==typeof b.getRandomValues,a=a&&"function"==typeof b.subtle.importKey,a=a&&"function"==typeof b.subtle.generateKey,a=a&&"function"==typeof b.subtle.exportKey,a=a&&"function"==typeof b.subtle.wrapKey,a=a&&"function"==typeof b.subtle.unwrapKey,a=a&&"function"==typeof b.subtle.encrypt,a=a&&"function"==typeof b.subtle.decrypt,a=a&&"function"==typeof b.subtle.sign,a=a&&"function"==typeof ArrayBuffer,a=a&&("function"==typeof e||"object"==typeof e),a=a&&("function"==typeof Uint32Array||"object"==typeof Uint32Array),a=a&&"object"==typeof JSON,a=a&&"function"==typeof JSON.parse,a=a&&"function"==typeof JSON.stringify,a=a&&"function"==typeof atob,a=a&&"function"==typeof btoa},f.assert=function(a,b){if(!a)throw new d(b)},a.Jose=f,a.JoseJWE=g,a.JoseJWS=h;var i=function(){this.setKeyEncryptionAlgorithm("RSA-OAEP"),this.setContentEncryptionAlgorithm("A256GCM"),this.setContentSignAlgorithm("RS256")};f.WebCryptographer=i,i.prototype.setKeyEncryptionAlgorithm=function(a){this.key_encryption=l(a)},i.prototype.getKeyEncryptionAlgorithm=function(){return this.key_encryption.jwe_name},i.prototype.setContentEncryptionAlgorithm=function(a){this.content_encryption=l(a)},i.prototype.getContentEncryptionAlgorithm=function(){return this.content_encryption.jwe_name},i.prototype.setContentSignAlgorithm=function(a){this.content_sign=n(a)},i.prototype.getContentSignAlgorithm=function(){return this.content_sign.jwa_name},i.prototype.createIV=function(){var a=new e(new Array(this.content_encryption.iv_bytes));return b.getRandomValues(a)},i.prototype.createCek=function(){var a=j(this.content_encryption);return b.subtle.generateKey(a.id,!0,a.enc_op)},i.prototype.wrapCek=function(a,c){return b.subtle.wrapKey("raw",a,c,this.key_encryption.id)},i.prototype.unwrapCek=function(a,c){var d=j(this.content_encryption),e=this.content_encryption.specific_cek_bytes>0,f=this.key_encryption.id;return b.subtle.unwrapKey("raw",a,c,f,d.id,e,d.dec_op)};var j=function(a){var b=a.specific_cek_bytes;if(b){if(16==b)return{id:{name:"AES-CBC",length:128},enc_op:["encrypt"],dec_op:["decrypt"]};if(32==b)return{id:{name:"AES-CBC",length:256},enc_op:["encrypt"],dec_op:["decrypt"]};if(64==b)return{id:{name:"HMAC",hash:{name:"SHA-256"}},enc_op:["sign"],dec_op:["verify"]};if(128==b)return{id:{name:"HMAC",hash:{name:"SHA-384"}},enc_op:["sign"],dec_op:["verify"]};f.assert(!1,"getCekWorkaround: invalid len")}return{id:a.id,enc_op:["encrypt"],dec_op:["decrypt"]}};i.prototype.encrypt=function(a,e,f,g){var h=this.content_encryption;if(a.length!=h.iv_bytes)return c.reject(d("invalid IV length"));if(h.auth.aead){var i=h.auth.tag_bytes,j={name:h.id.name,iv:a,additionalData:e,tagLength:8*i};return f.then(function(a){return b.subtle.encrypt(j,a,g).then(function(a){var b=a.byteLength-i;return{cipher:a.slice(0,b),tag:a.slice(b)}})})}var l=k(h,f,["encrypt"]),n=l[0],o=l[1],p=o.then(function(c){var d={name:h.id.name,iv:a};return b.subtle.encrypt(d,c,g)}),q=p.then(function(b){return m(h,n,e,a,b)});return c.all([p,q]).then(function(a){var b=a[0],c=a[1];return{cipher:b,tag:c}})},i.prototype.decrypt=function(a,g,h,i,j){var l=function(a,g,h,i){return f.assert(h instanceof e,"compare: invalid input"),f.assert(i instanceof e,"compare: invalid input"),g.then(function(f){var g=b.subtle.sign(a.auth.id,f,h),j=b.subtle.sign(a.auth.id,f,i);return c.all([g,j]).then(function(a){var b=new e(a[0]),f=new e(a[1]);if(b.length!=f.length)throw new d("compare failed");for(var g=0;g<b.length;g++)if(b[g]!=f[g])throw new d("compare failed");return c.accept(null)})})};if(h.length!=this.content_encryption.iv_bytes)return c.reject(d("decryptCiphertext: invalid IV"));var n=this.content_encryption;if(n.auth.aead){var o={name:n.id.name,iv:h,additionalData:g,tagLength:8*n.auth.tag_bytes};return a.then(function(a){var c=q.arrayBufferConcat(i,j);return b.subtle.decrypt(o,a,c)})}var p=k(n,a,["decrypt"]),r=p[0],s=p[1],t=m(n,r,g,h,i);return c.all([s,t]).then(function(a){var f=a[0],g=a[1];return l(n,r,new e(g),j).then(function(){var a={name:n.id.name,iv:h};return b.subtle.decrypt(a,f,i)}).catch(function(a){return c.reject(d("decryptCiphertext: MAC failed."))})})},i.prototype.sign=function(a,c,d){var e=this.content_sign;return a.alg&&(e=n(a.alg)),d.then(function(d){return b.subtle.sign(e.id,d,q.arrayFromString(q.Base64Url.encode(JSON.stringify(a))+"."+q.Base64Url.encodeArray(c)))})},i.prototype.verify=function(a,c,d,e,f){var g=this.content_sign;return e.then(function(e){return g=n(o(e)),b.subtle.verify(g.id,e,d,q.arrayFromString(a+"."+c)).then(function(a){return{kid:f,verified:a}})})},f.WebCryptographer.keyId=function(a){return q.sha256(a.n+"+"+a.d)};var k=function(a,e,f){var g=e.then(function(a){return b.subtle.exportKey("raw",a)}),h=g.then(function(e){if(8*e.byteLength!=a.id.length+8*a.auth.key_bytes)return c.reject(d("encryptPlainText: incorrect cek length"));var f=e.slice(0,a.auth.key_bytes);return b.subtle.importKey("raw",f,a.auth.id,!1,["sign"])}),i=g.then(function(e){if(8*e.byteLength!=a.id.length+8*a.auth.key_bytes)return c.reject(d("encryptPlainText: incorrect cek length"));var g=e.slice(a.auth.key_bytes);return b.subtle.importKey("raw",g,a.id,!1,f)});return[h,i]},l=function(a){switch(a){case"RSA-OAEP":return{jwe_name:"RSA-OAEP",id:{name:"RSA-OAEP",hash:{name:"SHA-1"}}};case"RSA-OAEP-256":return{jwe_name:"RSA-OAEP-256",id:{name:"RSA-OAEP",hash:{name:"SHA-256"}}};case"A128KW":return{jwe_name:"A128KW",id:{name:"AES-KW",length:128}};case"A256KW":return{jwe_name:"A256KW",id:{name:"AES-KW",length:256}};case"dir":return{jwe_name:"dir"};case"A128CBC-HS256":return{jwe_name:"A128CBC-HS256",id:{name:"AES-CBC",length:128},iv_bytes:16,specific_cek_bytes:32,auth:{key_bytes:16,id:{name:"HMAC",hash:{name:"SHA-256"}},truncated_bytes:16}};case"A256CBC-HS512":return{jwe_name:"A256CBC-HS512",id:{name:"AES-CBC",length:256},iv_bytes:16,specific_cek_bytes:64,auth:{key_bytes:32,id:{name:"HMAC",hash:{name:"SHA-512"}},truncated_bytes:32}};case"A128GCM":return{jwe_name:"A128GCM",id:{name:"AES-GCM",length:128},iv_bytes:12,auth:{aead:!0,tag_bytes:16}};case"A256GCM":return{jwe_name:"A256GCM",id:{name:"AES-GCM",length:256},iv_bytes:12,auth:{aead:!0,tag_bytes:16}};default:throw d("unsupported algorithm: "+a)}},m=function(a,c,d,f,g){return c.then(function(c){var h=new e(q.arrayFromInt32(8*d.length)),i=new e(8);i.set(h,4);var j=q.arrayBufferConcat(d,f,g,i);return b.subtle.sign(a.auth.id,c,j).then(function(b){return b.slice(0,a.auth.truncated_bytes)})})},n=function(a){switch(a){case"RS256":return{jwa_name:"RS256",id:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}}};case"RS384":return{jwa_name:"RS384",id:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}}};case"RS512":return{jwa_name:"RS512",id:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}}};case"PS256":return{jwa_name:"PS256",id:{name:"RSA-PSS",hash:{name:"SHA-256"},saltLength:20}};case"PS384":return{jwa_name:"PS384",id:{name:"RSA-PSS",hash:{name:"SHA-384"},saltLength:20}};case"PS512":return{jwa_name:"PS512",id:{name:"RSA-PSS",hash:{name:"SHA-512"},saltLength:20}};case"HS256":return{jwa_name:"HS256",id:{name:"HMAC",hash:{name:"SHA-256"}}};case"HS384":return{jwa_name:"HS384",id:{name:"HMAC",hash:{name:"SHA-384"}}};case"HS512":return{jwa_name:"HS512",id:{name:"HMAC",hash:{name:"SHA-512"}}};case"ES256":return{jwa_name:"ES256",id:{name:"ECDSA",hash:{name:"SHA-256"}}};case"ES384":return{jwa_name:"ES384",id:{name:"ECDSA",hash:{name:"SHA-384"}}};case"ES512":return{jwa_name:"ES512",id:{name:"ECDSA",hash:{name:"SHA-512"}}};default:throw d("unsupported algorithm: "+a)}},o=function(a){var b="",c=a.algorithm.name,e=a.algorithm.hash.name;if("RSASSA-PKCS1-v1_5"==c)b="R";else{if("RSA-PSS"!=c)throw new d("unsupported sign/verify algorithm "+c);b="P"}if(0!==e.indexOf("SHA-"))throw new d("unsupported hash algorithm "+c);return b+="S",b+=e.substring(4)},p=function(a){switch(a){case"RS256":case"RS384":case"RS512":case"PS256":case"PS384":case"PS512":case"HS256":case"HS384":case"HS512":case"ES256":case"ES384":case"ES512":return{publicKey:"verify",privateKey:"sign"};case"RSA-OAEP":case"RSA-OAEP-256":case"A128KW":case"A256KW":return{publicKey:"wrapKey",privateKey:"unwrapKey"};default:throw d("unsupported algorithm: "+a)}};f.Utils={};var q={};f.Utils.importRsaPublicKey=function(a,c){var d,e,f=p(c);if("wrapKey"==f.publicKey)a.alg||(a.alg=c),d=q.convertRsaKey(a,["n","e"]),e=l(c);else{var g={};for(var h in a)a.hasOwnProperty(h)&&(g[h]=a[h]);!g.alg&&c&&(g.alg=c),e=n(g.alg),d=q.convertRsaKey(g,["n","e"]),d.ext=!0}return b.subtle.importKey("jwk",d,e.id,!1,[f.publicKey])},f.Utils.importRsaPrivateKey=function(a,c){var d,e,f=p(c);if("unwrapKey"==f.privateKey)a.alg||(a.alg=c),d=q.convertRsaKey(a,["n","e","d","p","q","dp","dq","qi"]),e=l("RSA-OAEP");else{var g={};for(var h in a)a.hasOwnProperty(h)&&(g[h]=a[h]);e=n(c),!g.alg&&c&&(g.alg=c),d=q.convertRsaKey(g,["n","e","d","p","q","dp","dq","qi"]),d.ext=!0}return b.subtle.importKey("jwk",d,e.id,!1,[f.privateKey])},q.isString=function(a){return"string"==typeof a||a instanceof String},q.arrayish=function(a){return a instanceof Array?a:a instanceof e?a:a instanceof ArrayBuffer?new e(a):void f.assert(!1,"arrayish: invalid input")},q.convertRsaKey=function(a,b){var c,d={},e=[];b.map(function(b){"undefined"==typeof a[b]&&e.push(b)}),e.length>0&&f.assert(!1,"convertRsaKey: Was expecting "+e.join()),"undefined"!=typeof a.kty&&f.assert("RSA"==a.kty,"convertRsaKey: expecting rsa_key['kty'] to be 'RSA'"),d.kty="RSA";try{n(a.alg),c=a.alg}catch(b){try{l(a.alg),c=a.alg}catch(a){f.assert(c,"convertRsaKey: expecting rsa_key['alg'] to have a valid value")}}d.alg=c;for(var g=function(a){return parseInt(a,16)},h=0;h<b.length;h++){var i=b[h],j=a[i];if("e"==i)"number"==typeof j&&(j=q.Base64Url.encodeArray(q.stripLeadingZeros(q.arrayFromInt32(j))));else if(/^([0-9a-fA-F]{2}:)+[0-9a-fA-F]{2}$/.test(j)){var k=j.split(":").map(g);j=q.Base64Url.encodeArray(q.stripLeadingZeros(k))}else"string"!=typeof j&&f.assert(!1,"convertRsaKey: expecting rsa_key['"+i+"'] to be a string");d[i]=j}return d},q.arrayFromString=function(a){f.assert(q.isString(a),"arrayFromString: invalid input");var b=a.split("").map(function(a){return a.charCodeAt(0)});return new e(b)},q.stringFromArray=function(a){f.assert(a instanceof ArrayBuffer,"stringFromArray: invalid input"),a=new e(a);for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a[c]);return b},q.utf8BytesFromString=function(a){for(var b=[],c=0,d=0;d<a.length;d++){var f=a.charCodeAt(d);f<128?b[c++]=f:f<2048?(b[c++]=f>>6|192,b[c++]=63&f|128):55296==(64512&f)&&d+1<a.length&&56320==(64512&a.charCodeAt(d+1))?(f=65536+((1023&f)<<10)+(1023&a.charCodeAt(++d)),b[c++]=f>>18|240,b[c++]=f>>12&63|128,b[c++]=f>>6&63|128,b[c++]=63&f|128):(b[c++]=f>>12|224,b[c++]=f>>6&63|128,b[c++]=63&f|128)}return new e(b)},q.stringFromUtf8Bytes=function(a){for(var b,c,d,e=q.arrayish(a),f=[],g=0,h=0;g<e.length;){var i=e[g++];if(i<128)f[h++]=String.fromCharCode(i);else if(i>191&&i<224)b=e[g++],f[h++]=String.fromCharCode((31&i)<<6|63&b);else if(i>239&&i<365){b=e[g++],c=e[g++],d=e[g++];var j=((7&i)<<18|(63&b)<<12|(63&c)<<6|63&d)-65536;f[h++]=String.fromCharCode(55296+(j>>10)),f[h++]=String.fromCharCode(56320+(1023&j))}else b=e[g++],c=e[g++],f[h++]=String.fromCharCode((15&i)<<12|(63&b)<<6|63&c)}return f.join("")},q.stripLeadingZeros=function(a){a instanceof ArrayBuffer&&(a=new e(a));for(var b=!0,c=[],d=0;d<a.length;d++)b&&0===a[d]||(b=!1,c.push(a[d]));return c},q.arrayFromInt32=function(a){f.assert("number"==typeof a,"arrayFromInt32: invalid input"),f.assert(a==a|0,"arrayFromInt32: out of range");for(var b=new e(new Uint32Array([a]).buffer),c=new e(4),d=0;d<4;d++)c[d]=b[3-d];return c.buffer},q.arrayBufferConcat=function(){for(var a=[],b=0,c=0;c<arguments.length;c++)a.push(q.arrayish(arguments[c])),b+=a[c].length;var d=new e(b),g=0;for(c=0;c<arguments.length;c++)for(var h=0;h<a[c].length;h++)d[g++]=a[c][h];return f.assert(g==b,"arrayBufferConcat: unexpected offset"),d},q.Base64Url={},q.Base64Url.lookup=[],q.Base64Url.revLookup=[],q.Base64Url.initTables=function(){for(var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",b=0,c=a.length;b<c;++b)q.Base64Url.lookup[b]=a[b],q.Base64Url.revLookup[a.charCodeAt(b)]=b},q.Base64Url.initTables(),q.Base64Url.decodeArray=function(a){var b,c,d,f,g,h,i=a.length;i%4>0&&(a+="===".slice(0,4-a.length%4),i=a.length),g="="===a[i-2]?2:"="===a[i-1]?1:0,h=new e(3*i/4-g),d=g>0?i-4:i;var j=0;for(b=0,c=0;b<d;b+=4,c+=3)f=q.Base64Url.revLookup[a.charCodeAt(b)]<<18|q.Base64Url.revLookup[a.charCodeAt(b+1)]<<12|q.Base64Url.revLookup[a.charCodeAt(b+2)]<<6|q.Base64Url.revLookup[a.charCodeAt(b+3)],h[j++]=f>>16&255,h[j++]=f>>8&255,h[j++]=255&f;return 2===g?(f=q.Base64Url.revLookup[a.charCodeAt(b)]<<2|q.Base64Url.revLookup[a.charCodeAt(b+1)]>>4,h[j++]=255&f):1===g&&(f=q.Base64Url.revLookup[a.charCodeAt(b)]<<10|q.Base64Url.revLookup[a.charCodeAt(b+1)]<<4|q.Base64Url.revLookup[a.charCodeAt(b+2)]>>2,h[j++]=f>>8&255,h[j++]=255&f),h},q.Base64Url.tripletToBase64=function(a){return q.Base64Url.lookup[a>>18&63]+q.Base64Url.lookup[a>>12&63]+q.Base64Url.lookup[a>>6&63]+q.Base64Url.lookup[63&a]},q.Base64Url.encodeChunk=function(a,b,c){for(var d,e=[],f=b;f<c;f+=3)d=(a[f]<<16)+(a[f+1]<<8)+a[f+2],e.push(q.Base64Url.tripletToBase64(d));return e.join("")},q.Base64Url.encodeArray=function(a){a=q.arrayish(a);for(var b,c=a.length,d=c%3,e="",f=[],g=16383,h=0,i=c-d;h<i;h+=g)f.push(q.Base64Url.encodeChunk(a,h,h+g>i?i:h+g));return 1===d?(b=a[c-1],e+=q.Base64Url.lookup[b>>2],e+=q.Base64Url.lookup[b<<4&63]):2===d&&(b=(a[c-2]<<8)+a[c-1],e+=q.Base64Url.lookup[b>>10],e+=q.Base64Url.lookup[b>>4&63],e+=q.Base64Url.lookup[b<<2&63]),f.push(e),f.join("")},q.Base64Url.encode=function(a){f.assert(q.isString(a),"Base64Url.encode: invalid input");var b=q.utf8BytesFromString(a),c=q.Base64Url.encodeArray(b);return c.replace(/=+$/,"")},q.Base64Url.decode=function(a){f.assert(q.isString(a),"Base64Url.decode: invalid input");var b=q.Base64Url.decodeArray(a),c=q.stringFromUtf8Bytes(b);return c},q.sha256=function(a){return b.subtle.digest({name:"SHA-256"},q.arrayFromString(a)).then(function(a){return q.Base64Url.encodeArray(a)})},q.isCryptoKey=function(a){return"CryptoKey"==a.constructor.name},g.Encrypter=function(a,b){this.cryptographer=a,this.key_promise=b,this.userHeaders={}},g.Encrypter.prototype.addHeader=function(a,b){this.userHeaders[a]=b},g.Encrypter.prototype.encrypt=function(a){var b,d,e=function(a,b){var c={};for(var d in this.userHeaders)c[d]=this.userHeaders[d];c.alg=this.cryptographer.getKeyEncryptionAlgorithm(),c.enc=this.cryptographer.getContentEncryptionAlgorithm();var e=q.Base64Url.encode(JSON.stringify(c)),f=this.cryptographer.createIV(),g=q.arrayFromString(e);return b=q.utf8BytesFromString(b),this.cryptographer.encrypt(f,g,a,b).then(function(a){return a.header=e,a.iv=f,a})};"dir"==this.cryptographer.getKeyEncryptionAlgorithm()?(b=c.resolve(this.key_promise),d=[]):(b=this.cryptographer.createCek(),d=c.all([this.key_promise,b]).then(function(a){var b=a[0],c=a[1];return this.cryptographer.wrapCek(c,b)}.bind(this)));var f=e.bind(this,b,a)();return c.all([d,f]).then(function(a){var b=a[0],c=a[1];return c.header+"."+q.Base64Url.encodeArray(b)+"."+q.Base64Url.encodeArray(c.iv)+"."+q.Base64Url.encodeArray(c.cipher)+"."+q.Base64Url.encodeArray(c.tag)})},g.Decrypter=function(a,b){this.cryptographer=a,this.key_promise=b,this.headers={}},g.Decrypter.prototype.getHeaders=function(){return this.headers},g.Decrypter.prototype.decrypt=function(a){var b=a.split(".");if(5!=b.length)return c.reject(d("decrypt: invalid input"));if(this.headers=JSON.parse(q.Base64Url.decode(b[0])),!this.headers.alg)return c.reject(d("decrypt: missing alg"));if(!this.headers.enc)return c.reject(d("decrypt: missing enc"));if(this.cryptographer.setKeyEncryptionAlgorithm(this.headers.alg),this.cryptographer.setContentEncryptionAlgorithm(this.headers.enc),this.headers.crit)return c.reject(d("decrypt: crit is not supported"));var e;if("dir"==this.headers.alg)e=c.resolve(this.key_promise);else{var f=q.Base64Url.decodeArray(b[1]);e=this.key_promise.then(function(a){return this.cryptographer.unwrapCek(f,a)}.bind(this))}var g=this.cryptographer.decrypt(e,q.arrayFromString(b[0]),q.Base64Url.decodeArray(b[2]),q.Base64Url.decodeArray(b[3]),q.Base64Url.decodeArray(b[4]));return g.then(q.stringFromUtf8Bytes)},h.Signer=function(a){this.cryptographer=a,this.key_promises={},this.waiting_kid=0,this.headers={},this.signer_aads={},this.signer_headers={}},h.Signer.prototype.addSigner=function(a,b,e,g){var h,i=this;if(q.isCryptoKey(a))h=new c(function(b){b(a)});else{var j;j=e&&e.alg?e.alg:i.cryptographer.getContentSignAlgorithm(),h=f.Utils.importRsaPrivateKey(a,j,"sign")}var k;if(b)k=new c(function(a){a(b)});else{if(q.isCryptoKey(a))throw new d("key_id is a mandatory argument when the key is a CryptoKey");k=f.WebCryptographer.keyId(a)}return i.waiting_kid++,k.then(function(a){return i.key_promises[a]=h,i.waiting_kid--,e&&(i.signer_aads[a]=e),g&&(i.signer_headers[a]=g),a})},h.Signer.prototype.addSignature=function(a,b,c){if(q.isString(a)&&(a=JSON.parse(a)),a.payload&&q.isString(a.payload)&&a.protected&&q.isString(a.protected)&&a.header&&a.header instanceof Object&&a.signature&&q.isString(a.signature))return this.sign(r.fromObject(a),b,c);throw new d("JWS is not a valid JWS object")},h.Signer.prototype.sign=function(a,b,c){function e(a,b,c,e,f){var h;if(b||(b={}),b.alg||(b.alg=g.cryptographer.getContentSignAlgorithm(),b.typ="JWT"),b.kid||(b.kid=f),q.isString(a))h=q.utf8BytesFromString(a);else try{h=q.arrayish(a)}catch(b){if(a instanceof r)h=q.arrayFromString(q.Base64Url.decode(a.payload));else{if(!(a instanceof Object))throw new d("cannot sign this message");h=q.arrayFromString(JSON.stringify(a))}}return g.cryptographer.sign(b,h,e).then(function(d){var e=new r(b,c,h,d);return a instanceof r?(delete e.payload,a.signatures?a.signatures.push(e):a.signatures=[e],a):e})}function f(a,b,c,d,h){if(h.length){var i=h.shift(),j=e(a,g.signer_aads[i]||b,g.signer_headers[i]||c,d[i],i);return h.length&&(j=j.then(function(a){return f(a,null,null,d,h)})),j}}var g=this,h=[];if(0===Object.keys(g.key_promises).length)throw new d("No signers defined. At least one is required to sign the JWS.");if(g.waiting_kid)throw new d("still generating key IDs");for(var i in g.key_promises)g.key_promises.hasOwnProperty(i)&&h.push(i);return f(a,b,c,g.key_promises,h)};var r=function(a,b,c,d){this.header=b,this.payload=q.Base64Url.encodeArray(c),d&&(this.signature=q.Base64Url.encodeArray(d)),this.protected=q.Base64Url.encode(JSON.stringify(a))};r.fromObject=function(a){var b=new r(a.protected,a.header,a.payload,null);return b.signature=a.signature,b.signatures=a.signatures,b},r.prototype.JsonSerialize=function(){return JSON.stringify(this)},r.prototype.CompactSerialize=function(){return this.protected+"."+this.payload+"."+this.signature},h.Verifier=function(a,b,c){var e,g,h,i,j,k,l,m=this,n=/^([0-9a-z_\-]+)\.([0-9a-z_\-]+)\.([0-9a-z_\-]+)$/i;if(m.cryptographer=a,e=a.getContentSignAlgorithm(),m.cryptographer=new f.WebCryptographer,q.isString(b))if(g=n.exec(b)){if(4!=g.length)throw new d("wrong JWS compact serialization format");b={protected:g[1],payload:g[2],signature:g[3]}}else b=JSON.parse(b);else if("object"!=typeof b)throw new d("data format not supported");h=b.protected,i=b.header,j=b.payload,k=b.signatures instanceof Array?b.signatures.slice(0):[],k.forEach(function(a){a.aad=a.protected,a.protected=JSON.parse(q.Base64Url.decode(a.protected))}),m.aad=h,l=q.Base64Url.decode(h);try{l=JSON.parse(l)}catch(a){}if(!l&&!i)throw new d("at least one header is required");if(!l.alg)throw new d("'alg' is a mandatory header");if(l.alg!=e)throw new d("the alg header '"+l.alg+"' doesn't match the requested algorithm '"+e+"'");if(l&&l.typ&&"JWT"!=l.typ)throw new d("typ '"+l.typ+"' not supported");b.signature&&k.unshift({aad:h,protected:l,header:i,signature:b.signature}),m.signatures=[];for(var o=0;o<k.length;o++)m.signatures[o]=JSON.parse(JSON.stringify(k[o])),m.signatures[o].signature=q.Base64Url.decodeArray(k[o].signature);m.payload=j,m.key_promises={},m.waiting_kid=0,c&&(m.keyfinder=c)},h.Verifier.prototype.addRecipient=function(a,b,e){var g,h=this,i=q.isCryptoKey(a)?new c(function(b){b(a)}):f.Utils.importRsaPublicKey(a,e||h.cryptographer.getContentSignAlgorithm(),"verify");if(b)g=new c(function(a){a(b)});else{if(q.isCryptoKey(a))throw new d("key_id is a mandatory argument when the key is a CryptoKey");console.log("it's not safe to not pass a key_id"),g=f.WebCryptographer.keyId(a)}return h.waiting_kid++,g.then(function(a){return h.key_promises[a]=i,h.waiting_kid--,a})},h.Verifier.prototype.verify=function(){var a=this,b=a.signatures,e=a.key_promises,f=a.keyfinder,g=[],h=!!f||Object.keys(a.key_promises).length>0;if(!h)throw new d("No recipients defined. At least one is required to verify the JWS.");if(a.waiting_kid)throw new d("still generating key IDs");return b.forEach(function(b){var c=b.protected.kid;f&&(e[c]=f(c)),g.push(a.cryptographer.verify(b.aad,a.payload,b.signature,e[c],c))}),c.all(g)}}(window,window.crypto,window.Promise,window.Error,window.Uint8Array);